name: Generate monthly changelog


on:
workflow_dispatch:
inputs:
since:
description: "Data inicial (AAAA-MM-DD)"
required: true
until:
description: "Data final (AAAA-MM-DD)"
required: truename: Generate monthly changelog

on:
  workflow_dispatch:
    inputs:
      since:
        description: "Data inicial (AAAA-MM-DD)"
        required: true
        type: string
      until:
        description: "Data final (AAAA-MM-DD)"
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Build changelog content (Issues fechadas no per√≠odo)
        id: build
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const since = core.getInput('since');
            const until = core.getInput('until');
            const month = since.slice(0,7); // AAAA-MM
            const { owner, repo } = context.repo;

            async function search(q) {
              const results = await github.paginate(
                github.rest.search.issuesAndPullRequests,
                { q, per_page: 100 }
              );
              // mant√©m s√≥ issues (remove PRs)
              return results.filter(i => !i.pull_request);
            }

            const base = `repo:${owner}/${repo} is:issue is:closed label:"status:done" closed:${since}..${until}`;
            const enhancements = await search(`${base} label:"type:enhancement"`);
            const bugs = await search(`${base} label:"type:bug"`);

            const toLines = (list) =>
              list.length ? list.map(i => `- ${i.title} (#${i.number})`) : ['- _sem itens_'];

            const lines = [
              `# Changelog ‚Äî ${month}`,
              '',
              '## ‚ú® Melhorias',
              ...toLines(enhancements),
              '',
              '## üêû Corre√ß√µes',
              ...toLines(bugs),
              '',
              '## üìå Observa√ß√µes',
              '- (adicione notas, migra√ß√µes, etc. se necess√°rio)',
            ];

            const dir = path.join(process.cwd(), 'changelogs');
            const file = path.join(dir, `${month}.md`);
            fs.mkdirSync(dir, { recursive: true });
            fs.writeFileSync(file, lines.join('\n'), 'utf8');

            core.setOutput('file', `changelogs/${month}.md`);

      - name: Commit changelog file
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            chore(changelog): add ${{ inputs.since }}..${{ inputs.until }}
          file_pattern: changelogs/*.md
