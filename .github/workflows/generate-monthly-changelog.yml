name: Generate monthly changelog

on:
  workflow_dispatch:
    inputs:
      since:
        description: "Data inicial (AAAA-MM-DD)"
        required: true
        type: string
      until:
        description: "Data final (AAAA-MM-DD)"
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Build changelog content (Issues fechadas no per√≠odo)
        id: build
        uses: actions/github-script@v7
        with:
          # >>> PASSA OS INPUTS PARA O STEP <<<
          since: ${{ inputs.since }}
          until: ${{ inputs.until }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const { owner, repo } = context.repo;

            const since = core.getInput('since');
            const until = core.getInput('until');

            // valida formato AAAA-MM-DD
            const rx = /^\d{4}-\d{2}-\d{2}$/;
            if (!rx.test(since) || !rx.test(until)) {
              core.setFailed(`Datas inv√°lidas: since='${since}', until='${until}'. Use AAAA-MM-DD.`);
              return;
            }

            const month = since.slice(0, 7); // AAAA-MM

            async function search(q) {
              const res = await github.paginate(
                github.rest.search.issuesAndPullRequests,
                { q, per_page: 100 }
              );
              // manter s√≥ issues (descarta PRs)
              return res.filter(i => !i.pull_request);
            }

            const base = `repo:${owner}/${repo} is:issue is:closed label:"status:done" closed:${since}..${until}`;
            const enhancements = await search(`${base} label:"type:enhancement"`);
            const bugs = await search(`${base} label:"type:bug"`);

            const toLines = list =>
              list.length ? list.map(i => `- ${i.title} (#${i.number})`) : ['- _sem itens_'];

            const lines = [
              `# Changelog ‚Äî ${month}`,
              '',
              '## ‚ú® Melhorias',
              ...toLines(enhancements),
              '',
              '## üêû Corre√ß√µes',
              ...toLines(bugs),
              '',
              '## üìå Observa√ß√µes',
              '- (adicione notas, migra√ß√µes, etc. se necess√°rio)',
            ];

            const outDir = path.join(process.cwd(), 'changelogs');
            const outFile = path.join(outDir, `${month}.md`);
            fs.mkdirSync(outDir, { recursive: true });
            fs.writeFileSync(outFile, lines.join('\n'), 'utf8');

            core.setOutput('file', `changelogs/${month}.md`);

      - name: Commit changelog file
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(changelog): add ${{ inputs.since }}..${{ inputs.until }}"
          file_pattern: changelogs/*.md
